---
import MapPopupTemplate from "@/components/MapPopupTemplate.astro";

import "maplibre-gl/dist/maplibre-gl.css";

const { year } = Astro.props;
---

<div id="map" class="h-full" data-year={year}></div>

<MapPopupTemplate />

<script>
  import maplibregl from "maplibre-gl";

  const year = document.getElementById("map")!.dataset.year;

  // 1. Single reference to manage the active popup across all layers
  let activePopup: maplibregl.Popup | null = null;

  const map = new maplibregl.Map({
    container: "map",
    style: "https://tiles.openfreemap.org/styles/positron",
    center: [5.4025, 51.2194],
    zoom: 7,
  });

  map.on("load", async () => {
    map.addSource("teams", {
      type: "geojson",
      data: `/data/${year}-teams.json`,
    });

    map.addSource("events", {
      type: "geojson",
      data: `/data/${year}-events.json`,
    });

    map.addLayer({
      id: "teams-layer",
      type: "circle",
      source: "teams",
      paint: {
        "circle-radius": 6,
        "circle-color": "#FF5722",
        "circle-stroke-width": 2,
        "circle-stroke-color": "#FFFFFF",
      },
    });

    map.addLayer({
      id: "events-layer",
      type: "circle",
      source: "events",
      paint: {
        "circle-radius": 8,
        "circle-color": "#3F51B5",
        "circle-stroke-width": 2,
        "circle-stroke-color": "#FFFFFF",
      },
    });

    // 2. A shared click handler for both layers
    const handleLayerClick = (e: any) => {
      if (!e.features || !e.features.length) return;

      // Close the previous popup if it exists
      if (activePopup) {
        activePopup.remove();
      }

      const feature = e.features[0];
      const geometry = feature.geometry;
      if (geometry.type !== "Point") return;

      const coordinates = geometry.coordinates.slice() as [number, number];
      const properties = feature.properties;
      const layerId = feature.layer.id;

      // Ensure popup appears correctly even if the map is wrapped
      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      const template = document.getElementById(
        "popup-template",
      ) as HTMLTemplateElement;
      const clone = template.content.cloneNode(true) as HTMLElement;

      // 3. Logic branching based on which layer was clicked
      if (layerId === "teams-layer") {
        clone.querySelector(".card-team-name")!.textContent =
          properties?.name || "N/A";
        clone.querySelector(".card-team-number")!.textContent =
          properties?.number || "N/A";
        clone.querySelector(".card-left-label")!.textContent = "Organization";
        clone.querySelector(".card-left-value")!.textContent =
          properties?.org || "N/A";
        clone.querySelector(".card-right-label")!.textContent = "Rookie Year";
        clone.querySelector(".card-right-value")!.textContent =
          properties?.rookieYear || "N/A";
        clone
          .querySelector(".card-view-details")!
          .setAttribute(
            "href",
            `https://ftc-events.firstinspires.org/${year}/team/${properties?.number}`,
          );
      } else if (layerId === "events-layer") {
        clone.querySelector(".card-team-name")!.textContent =
          properties?.name || "N/A";
        clone.querySelector(".card-team-number")!.textContent =
          properties?.typeName || "N/A";
        clone.querySelector(".card-left-label")!.textContent = "Venue";
        clone.querySelector(".card-left-value")!.textContent =
          properties?.venue || "N/A";
        clone.querySelector(".card-right-label")!.textContent = "Date";
        clone.querySelector(".card-right-value")!.textContent =
          getDateString(
            new Date(properties?.dateStart),
            new Date(properties?.dateEnd),
          ) || "N/A";
        clone
          .querySelector(".card-view-details")!
          .setAttribute(
            "href",
            `https://ftc-events.firstinspires.org/${year}/${properties?.code}`,
          );
      }

      // 4. Create the popup and assign it to the shared variable
      activePopup = new maplibregl.Popup({
        closeButton: false,
        closeOnClick: true,
        className: "popup",
        maxWidth: "none",
      })
        .setLngLat(coordinates)
        .setDOMContent(clone)
        .addTo(map);

      // Clear the reference when the popup is closed
      activePopup.on("close", () => {
        activePopup = null;
      });
    };

    // Attach the single handler to both layers
    map.on("click", "teams-layer", handleLayerClick);
    map.on("click", "events-layer", handleLayerClick);

    // Hover effects
    const layers = ["teams-layer", "events-layer"];
    layers.forEach((layer) => {
      map.on("mouseenter", layer, () => {
        map.getCanvas().style.cursor = "pointer";
      });
      map.on("mouseleave", layer, () => {
        map.getCanvas().style.cursor = "";
      });
    });
  });

  function getDateString(startDate: Date, endDate: Date): string {
    const formatter = new Intl.DateTimeFormat(undefined, {
      day: "numeric",
      month: "short",
      year: "numeric",
    });
    return formatter.formatRange(startDate, endDate);
  }
</script>

<style is:global>
  .maplibregl-popup-content {
    padding: 0 !important;
    background: transparent !important;
    box-shadow: none !important;
  }
</style>
